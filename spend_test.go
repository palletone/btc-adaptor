package adaptorbtc

import (
	"fmt"
	"strings"
	"testing"

	"github.com/palletone/adaptor"
)

func TestSignTransaction(t *testing.T) {
	rpcParams := RPCParams{
		Host:      "localhost:18332",
		RPCUser:   "zxl",
		RPCPasswd: "123456",
		CertPath:  GCertPath,
	}
	theComplete := `"complete":true`

	params2In1Out := &adaptor.SignTransactionParams{
		TransactionHex: "0100000002897b0b90db2e7eebdd82bfd18a01bdf18a9c8cc7c10df8e19ff131c04fa696160000000000ffffffffea60d9d11cc3e40e17f068ca1191ff5d3ec11d016393addf63305001ce813c990000000000ffffffff01f85b0c09000000001976a9140f08e55bcfc207632d2dcfc3d4db4b6d8d91b22e88ac00000000",
		RedeemHex:      "",
	}
	params2In1Out.Privkeys = append(params2In1Out.Privkeys, "cUakDAWEeNeXTo3B93WBs9HRMfaFDegXcbEGooLz8BSxRBfmpYcX")

	//the return 'transactionhex' is used in next step
	result2In1Out, err := SignTransaction(params2In1Out, &rpcParams, NETID_TEST)
	if err != nil {
		fmt.Println(err.Error())
	} else {
		if strings.Contains(result2In1Out, theComplete) {
			t.Errorf("complete - got: true, want: false")
		}
		fmt.Println(result2In1Out)
	}
	return

	//from TestRawTransactionGen A --> M2N3
	//params := `{
	//"transactionhex": "010000000236045404e65bd741109db92227ca0dc9274ef717a6612c96cd77b24a17d1bcd70000000000ffffffff7c1f7d5407b41abf29d41cf6f122ef2d40f76d956900d2c89314970951ef5b940000000000ffffffff014431d309000000001976a914bddc9a62e9b7c3cfdbe1c817520e24e32c339f3288ac00000000",
	//"redeemhex": "522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553ae",
	//"privkeys": ["cUakDAWEeNeXTo3B93WBs9HRMfaFDegXcbEGooLz8BSxRBfmpYcX"]
	//}`

	params := &adaptor.SignTransactionParams{
		TransactionHex: "010000000236045404e65bd741109db92227ca0dc9274ef717a6612c96cd77b24a17d1bcd70000000000ffffffff7c1f7d5407b41abf29d41cf6f122ef2d40f76d956900d2c89314970951ef5b940000000000ffffffff014431d309000000001976a914bddc9a62e9b7c3cfdbe1c817520e24e32c339f3288ac00000000",
		RedeemHex:      "522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553ae",
	}
	params.Privkeys = append(params.Privkeys, "cUakDAWEeNeXTo3B93WBs9HRMfaFDegXcbEGooLz8BSxRBfmpYcX")

	//the return 'transactionhex' is used in next step
	result, err := SignTransaction(params, &rpcParams, NETID_TEST)
	if err != nil {
		fmt.Println(err.Error())
	} else {
		if strings.Contains(result, theComplete) {
			t.Errorf("complete - got: true, want: false")
		}
		fmt.Println(result)
	}

	//replace with the return 'transactionhex' which in Previous step return
	//paramsSigned := `{
	//"transactionhex": "010000000236045404e65bd741109db92227ca0dc9274ef717a6612c96cd77b24a17d1bcd700000000b400473044022024e6a6ca006f25ccd3ebf5dadf21397a6d7266536cd336061cd17cff189d95e402205af143f6726d75ac77bc8c80edcb6c56579053d2aa31601b23bc8da41385dd86014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff7c1f7d5407b41abf29d41cf6f122ef2d40f76d956900d2c89314970951ef5b9400000000b40047304402206a1d7a2ae07840957bee708b6d3e1fbe7858760ac378b1e21209b348c1e2a5c402204255cd4cd4e5b5805d44bbebe7464aa021377dca5fc6bf4a5632eb2d8bc9f9e4014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff014431d309000000001976a914bddc9a62e9b7c3cfdbe1c817520e24e32c339f3288ac00000000",
	//"redeemhex": "522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553ae",
	//"privkeys": ["cQJB6w8SxVNoprVwp2xyxUFxvExMbpR2qj3banXYYXmhtTc1WxC8"]
	//}`
	paramsSigned := &adaptor.SignTransactionParams{
		TransactionHex: "010000000236045404e65bd741109db92227ca0dc9274ef717a6612c96cd77b24a17d1bcd700000000b400473044022024e6a6ca006f25ccd3ebf5dadf21397a6d7266536cd336061cd17cff189d95e402205af143f6726d75ac77bc8c80edcb6c56579053d2aa31601b23bc8da41385dd86014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff7c1f7d5407b41abf29d41cf6f122ef2d40f76d956900d2c89314970951ef5b9400000000b40047304402206a1d7a2ae07840957bee708b6d3e1fbe7858760ac378b1e21209b348c1e2a5c402204255cd4cd4e5b5805d44bbebe7464aa021377dca5fc6bf4a5632eb2d8bc9f9e4014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff014431d309000000001976a914bddc9a62e9b7c3cfdbe1c817520e24e32c339f3288ac00000000",
		RedeemHex:      "522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553ae",
	}
	paramsSigned.Privkeys = append(paramsSigned.Privkeys, "cQJB6w8SxVNoprVwp2xyxUFxvExMbpR2qj3banXYYXmhtTc1WxC8")

	//the result of 'M1 sign,then M2 sign' is same
	//
	//1. cUakDAWEeNeXTo3B93WBs9HRMfaFDegXcbEGooLz8BSxRBfmpYcX cQJB6w8SxVNoprVwp2xyxUFxvExMbpR2qj3banXYYXmhtTc1WxC8
	//010000000236045404e65bd741109db92227ca0dc9274ef717a6612c96cd77b24a17d1bcd700000000b400473044022024e6a6ca006f25ccd3ebf5dadf21397a6d7266536cd336061cd17cff189d95e402205af143f6726d75ac77bc8c80edcb6c56579053d2aa31601b23bc8da41385dd86014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff7c1f7d5407b41abf29d41cf6f122ef2d40f76d956900d2c89314970951ef5b9400000000b40047304402206a1d7a2ae07840957bee708b6d3e1fbe7858760ac378b1e21209b348c1e2a5c402204255cd4cd4e5b5805d44bbebe7464aa021377dca5fc6bf4a5632eb2d8bc9f9e4014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff014431d309000000001976a914bddc9a62e9b7c3cfdbe1c817520e24e32c339f3288ac00000000
	//010000000236045404e65bd741109db92227ca0dc9274ef717a6612c96cd77b24a17d1bcd700000000fdfd00004830450221009b4f02e07cab7f3c68125499d466d22086c02c3a921b7bebe32434106e6cf7f1022016894e5e1639420210d2b5ecff93c48f698e4bf4b189ed5cb2d275dbe91dcc4c01473044022024e6a6ca006f25ccd3ebf5dadf21397a6d7266536cd336061cd17cff189d95e402205af143f6726d75ac77bc8c80edcb6c56579053d2aa31601b23bc8da41385dd86014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff7c1f7d5407b41abf29d41cf6f122ef2d40f76d956900d2c89314970951ef5b9400000000fdfd0000483045022100ee6f94e09447b2dd66cd10a5b6c6ba4e6b3215d5a50d042bacac3c895c369705022079b97833c85c91cd15efe99d945f98be75143c46f7b2fd9ff95d5daeb1e4d9f70147304402206a1d7a2ae07840957bee708b6d3e1fbe7858760ac378b1e21209b348c1e2a5c402204255cd4cd4e5b5805d44bbebe7464aa021377dca5fc6bf4a5632eb2d8bc9f9e4014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff014431d309000000001976a914bddc9a62e9b7c3cfdbe1c817520e24e32c339f3288ac00000000
	//
	//2.cQJB6w8SxVNoprVwp2xyxUFxvExMbpR2qj3banXYYXmhtTc1WxC8 cUakDAWEeNeXTo3B93WBs9HRMfaFDegXcbEGooLz8BSxRBfmpYcX
	//010000000236045404e65bd741109db92227ca0dc9274ef717a6612c96cd77b24a17d1bcd700000000b5004830450221009b4f02e07cab7f3c68125499d466d22086c02c3a921b7bebe32434106e6cf7f1022016894e5e1639420210d2b5ecff93c48f698e4bf4b189ed5cb2d275dbe91dcc4c014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff7c1f7d5407b41abf29d41cf6f122ef2d40f76d956900d2c89314970951ef5b9400000000b500483045022100ee6f94e09447b2dd66cd10a5b6c6ba4e6b3215d5a50d042bacac3c895c369705022079b97833c85c91cd15efe99d945f98be75143c46f7b2fd9ff95d5daeb1e4d9f7014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff014431d309000000001976a914bddc9a62e9b7c3cfdbe1c817520e24e32c339f3288ac00000000
	//010000000236045404e65bd741109db92227ca0dc9274ef717a6612c96cd77b24a17d1bcd700000000fdfd00004830450221009b4f02e07cab7f3c68125499d466d22086c02c3a921b7bebe32434106e6cf7f1022016894e5e1639420210d2b5ecff93c48f698e4bf4b189ed5cb2d275dbe91dcc4c01473044022024e6a6ca006f25ccd3ebf5dadf21397a6d7266536cd336061cd17cff189d95e402205af143f6726d75ac77bc8c80edcb6c56579053d2aa31601b23bc8da41385dd86014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff7c1f7d5407b41abf29d41cf6f122ef2d40f76d956900d2c89314970951ef5b9400000000fdfd0000483045022100ee6f94e09447b2dd66cd10a5b6c6ba4e6b3215d5a50d042bacac3c895c369705022079b97833c85c91cd15efe99d945f98be75143c46f7b2fd9ff95d5daeb1e4d9f70147304402206a1d7a2ae07840957bee708b6d3e1fbe7858760ac378b1e21209b348c1e2a5c402204255cd4cd4e5b5805d44bbebe7464aa021377dca5fc6bf4a5632eb2d8bc9f9e4014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff014431d309000000001976a914bddc9a62e9b7c3cfdbe1c817520e24e32c339f3288ac00000000

	resultLast, err := SignTransaction(paramsSigned, &rpcParams, NETID_TEST)
	if err != nil {
		fmt.Println(err.Error())
	} else {
		if !strings.Contains(resultLast, theComplete) {
			t.Errorf("complete - got: false, want: true")
		}
	}
	fmt.Println(resultLast)

	return

	//from TestRawTransactionGen A --> B C
	//paramsTransToMultsigAddr := `{
	//"transactionhex": "010000000145796293a6d01a72d2b160dbaefe27acb659ad72d1a6d47b2e204c7be221998d0100000000ffffffff0200e1f5050000000017a9147e037d8b8093a7cf3a6ec83aa8c852761a5d0cce8730033c05000000001976a914bddc9a62e9b7c3cfdbe1c817520e24e32c339f3288ac00000000",
	//"redeemhex": "",
	//"privkeys": ["cTMEdR2JxzVMTJCVsCbuStzypevdchxneREZoJjLnmiMVGHTr8wZ"]
	//}`
	paramsTransToMultsigAddr := &adaptor.SignTransactionParams{
		TransactionHex: "010000000145796293a6d01a72d2b160dbaefe27acb659ad72d1a6d47b2e204c7be221998d0100000000ffffffff0200e1f5050000000017a9147e037d8b8093a7cf3a6ec83aa8c852761a5d0cce8730033c05000000001976a914bddc9a62e9b7c3cfdbe1c817520e24e32c339f3288ac00000000",
		RedeemHex:      "",
	}
	paramsTransToMultsigAddr.Privkeys = append(paramsTransToMultsigAddr.Privkeys, "cTMEdR2JxzVMTJCVsCbuStzypevdchxneREZoJjLnmiMVGHTr8wZ")
	//the return 'transactionhex' is used in next step
	resultTransToMultsigAddr, err := SignTransaction(paramsTransToMultsigAddr, &rpcParams, NETID_TEST)
	//	if !strings.Contains(resultTransToMultsigAddr, theComplete) {
	//		t.Errorf("complete - got: false, want: true")
	//	}
	fmt.Println(resultTransToMultsigAddr)
	return
}

func TestSendTransaction(t *testing.T) {
	rpcParams := RPCParams{
		Host:      "localhost:18332",
		RPCUser:   "zxl",
		RPCPasswd: "123456",
		CertPath:  GCertPath,
	}

	//from TestRawTransactionGen
	paramsSend := `{
    "transactionhex": "010000000145796293a6d01a72d2b160dbaefe27acb659ad72d1a6d47b2e204c7be221998d010000006a473044022020bc4bb2aa9419c7ed6bd2355c6ffd1a8a845ee0b03e00bfe7725cc4fdf32a3b022069b3275dc9ae5e6c66b2ead2afb18b50e029e5e1015ff8ad4c9c90a5c922a4660121020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cbffffffff0200e1f5050000000017a9147e037d8b8093a7cf3a6ec83aa8c852761a5d0cce8730033c05000000001976a914bddc9a62e9b7c3cfdbe1c817520e24e32c339f3288ac00000000"
  	}`

	resultHash := SendTransaction(paramsSend, &rpcParams)
	//	theHash := `"TransactionHah"`
	//	if !strings.Contains(resultHash, theHash) {
	//		t.Errorf("unexpected result - got: %s, "+
	//			"want: %s", resultHash, theHash)
	//	}
	fmt.Println(resultHash)
}

func TestMultisignOneByOne(t *testing.T) {
	sigTransaction, partSigedScript, complete := MultisignOneByOne("101d482b60cd3f74a61ce265d62e383456b9c21c84477931d207ea8f503d84cc", 0,
		100000000, 100000, "mgtT62nq65DsPPAzPp6KhsWoHjNQUR9Bu5",
		"522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553ae",
		"", "cUakDAWEeNeXTo3B93WBs9HRMfaFDegXcbEGooLz8BSxRBfmpYcX", NETID_TEST)
	fmt.Println(sigTransaction)
	fmt.Println(partSigedScript)

	sigTransaction, lastSigedScript, complete := MultisignOneByOne("101d482b60cd3f74a61ce265d62e383456b9c21c84477931d207ea8f503d84cc", 0,
		100000000, 100000, "mgtT62nq65DsPPAzPp6KhsWoHjNQUR9Bu5",
		"522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553ae",
		partSigedScript, "cQJB6w8SxVNoprVwp2xyxUFxvExMbpR2qj3banXYYXmhtTc1WxC8", NETID_TEST)
	fmt.Println(sigTransaction)
	fmt.Println(lastSigedScript)

	sigTransactionTest := "0100000001cc843d508fea07d2317947841cc2b95634382ed665e21ca6743fcd602b481d1000000000fc00473044022016f92f6342c945132779c12009cedc67f8eff461fdb7327153aa28aa42b1a37d02205fb1d6eefe06fdc1d003ed17f65d367178202b32dd619d7f2cc98cbf75ae84b50147304402200b552fc38bdefbd85c069df29ceed32e3d3199f2ef7dbbdb0c9a72de6612b9f2022041018a9ec1a9fae45b1902ba92a99f161c545598fb188835754f4c809817aaa4014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553aeffffffff01605af405000000001976a9140f08e55bcfc207632d2dcfc3d4db4b6d8d91b22e88ac00000000"
	lastSigedScriptTest := "00473044022016f92f6342c945132779c12009cedc67f8eff461fdb7327153aa28aa42b1a37d02205fb1d6eefe06fdc1d003ed17f65d367178202b32dd619d7f2cc98cbf75ae84b50147304402200b552fc38bdefbd85c069df29ceed32e3d3199f2ef7dbbdb0c9a72de6612b9f2022041018a9ec1a9fae45b1902ba92a99f161c545598fb188835754f4c809817aaa4014c69522103940ab29fbf214da2d8ec99c47db63879957311bd90d2f1c635828604d541051421020106ca23b4f28dbc83838ee4745accf90e5621fe70df5b1ee8f7e1b3b41b64cb21029d80ff37838e4989a6aa26af41149d4f671976329e9ddb9b78fdea9814ae6ef553ae"

	if !strings.Contains(sigTransaction, sigTransactionTest) {
		t.Errorf("unexpected address - got: %x, "+
			"want: %x", sigTransaction, sigTransactionTest)
	}
	if !strings.Contains(lastSigedScript, lastSigedScriptTest) {
		t.Errorf("unexpected address - got: %x, "+
			"want: %x", lastSigedScript, lastSigedScriptTest)
	}
	if !complete {
		t.Errorf("complete - got: false, want: true")
	}
}
